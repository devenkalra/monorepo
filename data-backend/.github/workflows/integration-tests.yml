name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: entitydb
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      meilisearch:
        image: getmeili/meilisearch:v1.5
        env:
          MEILI_MASTER_KEY: masterKey
          MEILI_NO_ANALYTICS: "true"
        options: >-
          --health-cmd "curl -f http://localhost:7700/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 7700:7700
      
      neo4j:
        image: neo4j:5-community
        env:
          NEO4J_AUTH: neo4j/testpassword
          NEO4J_dbms_security_procedures_unrestricted: apoc.*
          NEO4J_dbms_security_procedures_allowlist: apoc.*
        options: >-
          --health-cmd "cypher-shell -u neo4j -p testpassword 'RETURN 1' || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
        ports:
          - 7687:7687
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    env:
      # Django settings
      DJANGO_SETTINGS_MODULE: config.settings
      SECRET_KEY: test-secret-key-for-ci
      DEBUG: "False"
      ALLOWED_HOSTS: localhost,127.0.0.1
      
      # Database settings
      POSTGRES_DB: entitydb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/entitydb
      
      # MeiliSearch settings
      MEILISEARCH_URL: http://localhost:7700
      MEILI_MASTER_KEY: masterKey
      
      # Neo4j settings
      NEO4J_URI: bolt://localhost:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: testpassword
      
      # Redis settings
      REDIS_URL: redis://localhost:6379/0
      
      # Test settings
      DJANGO_CSRF_TRUSTED_ORIGINS: http://localhost:8000
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      working-directory: ./data-backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Wait for services
      run: |
        echo "Waiting for PostgreSQL..."
        for i in {1..30}; do
          if pg_isready -h localhost -p 5432 -U postgres; then
            echo "PostgreSQL is ready"
            break
          fi
          echo "Waiting... ($i/30)"
          sleep 2
        done
        
        echo "Waiting for MeiliSearch..."
        for i in {1..30}; do
          if curl -f http://localhost:7700/health > /dev/null 2>&1; then
            echo "MeiliSearch is ready"
            break
          fi
          echo "Waiting... ($i/30)"
          sleep 2
        done
        
        echo "Waiting for Neo4j..."
        pip install neo4j
        for i in {1..60}; do
          if python -c "from neo4j import GraphDatabase; driver = GraphDatabase.driver('bolt://localhost:7687', auth=('neo4j', 'testpassword')); driver.verify_connectivity(); driver.close()" 2>/dev/null; then
            echo "Neo4j is ready"
            break
          fi
          echo "Waiting... ($i/60)"
          sleep 2
        done
        
        echo "Waiting for Redis..."
        for i in {1..30}; do
          if redis-cli -h localhost ping > /dev/null 2>&1; then
            echo "Redis is ready"
            break
          fi
          echo "Waiting... ($i/30)"
          sleep 2
        done
    
    - name: Run migrations
      working-directory: ./data-backend
      run: |
        python manage.py migrate --noinput
    
    - name: Run integration tests
      working-directory: ./data-backend
      run: |
        python manage.py test people.tests.test_integration_full_stack --verbosity=2
      timeout-minutes: 10
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: data-backend/test-results/
        retention-days: 30

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      working-directory: ./data-backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8
    
    - name: Run flake8
      working-directory: ./data-backend
      run: |
        flake8 people/ config/ --max-line-length=120 --exclude=migrations,__pycache__,venv
      continue-on-error: true
    
    - name: Run Django checks
      working-directory: ./data-backend
      env:
        DJANGO_SETTINGS_MODULE: config.settings
        SECRET_KEY: test-secret-key
        DATABASE_URL: sqlite:///db.sqlite3
      run: |
        python manage.py check
