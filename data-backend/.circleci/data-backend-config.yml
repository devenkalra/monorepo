version: 2.1

# Define reusable executors
executors:
  python-executor:
    docker:
      - image: cimg/python:3.11
        environment:
          # Django settings
          DJANGO_SETTINGS_MODULE: config.settings
          SECRET_KEY: test-secret-key-for-ci
          DEBUG: "False"
          ALLOWED_HOSTS: localhost,127.0.0.1
          
          # Database settings
          POSTGRES_DB: entitydb
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/entitydb
          
          # MeiliSearch settings
          MEILISEARCH_URL: http://localhost:7700
          MEILI_MASTER_KEY: masterKey
          
          # Neo4j settings
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: testpassword
          
          # Redis settings
          REDIS_URL: redis://localhost:6379/0
          
          # Test settings
          DJANGO_CSRF_TRUSTED_ORIGINS: http://localhost:8000
          
      # PostgreSQL service
      - image: cimg/postgres:15.3
        environment:
          POSTGRES_DB: entitydb
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
      
      # MeiliSearch service
      - image: getmeili/meilisearch:v1.5
        environment:
          MEILI_MASTER_KEY: masterKey
          MEILI_NO_ANALYTICS: "true"
      
      # Neo4j service
      - image: neo4j:5-community
        environment:
          NEO4J_AUTH: neo4j/testpassword
          NEO4J_dbms_security_procedures_unrestricted: apoc.*
          NEO4J_dbms_security_procedures_allowlist: apoc.*
      
      # Redis service
      - image: cimg/redis:7.0

# Define reusable commands
commands:
  install-dependencies:
    description: "Install Python dependencies"
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "requirements.txt" }}
            - v1-dependencies-
      - run:
          name: Install dependencies
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
      - save_cache:
          paths:
            - ./venv
          key: v1-dependencies-{{ checksum "requirements.txt" }}
  
  wait-for-services:
    description: "Wait for all services to be ready"
    steps:
      - run:
          name: Wait for PostgreSQL
          command: |
            for i in {1..30}; do
              if pg_isready -h localhost -p 5432 -U postgres; then
                echo "PostgreSQL is ready"
                break
              fi
              echo "Waiting for PostgreSQL... ($i/30)"
              sleep 2
            done
      
      - run:
          name: Wait for MeiliSearch
          command: |
            for i in {1..30}; do
              if curl -f http://localhost:7700/health > /dev/null 2>&1; then
                echo "MeiliSearch is ready"
                break
              fi
              echo "Waiting for MeiliSearch... ($i/30)"
              sleep 2
            done
      
      - run:
          name: Wait for Neo4j
          command: |
            . venv/bin/activate
            pip install neo4j
            for i in {1..60}; do
              if python -c "from neo4j import GraphDatabase; driver = GraphDatabase.driver('bolt://localhost:7687', auth=('neo4j', 'testpassword')); driver.verify_connectivity(); driver.close()" 2>/dev/null; then
                echo "Neo4j is ready"
                break
              fi
              echo "Waiting for Neo4j... ($i/60)"
              sleep 2
            done
      
      - run:
          name: Wait for Redis
          command: |
            for i in {1..30}; do
              if redis-cli -h localhost ping > /dev/null 2>&1; then
                echo "Redis is ready"
                break
              fi
              echo "Waiting for Redis... ($i/30)"
              sleep 2
            done
  
  setup-database:
    description: "Run Django migrations"
    steps:
      - run:
          name: Run migrations
          command: |
            . venv/bin/activate
            python manage.py migrate --noinput

# Define jobs
jobs:
  test:
    executor: python-executor
    working_directory: ~/repo/data-backend
    steps:
      - checkout:
          path: ~/repo
      
      - install-dependencies
      
      - wait-for-services
      
      - setup-database
      
      - run:
          name: Run integration tests
          command: |
            . venv/bin/activate
            python manage.py test people.tests.test_integration_full_stack --verbosity=2
          no_output_timeout: 10m
      
      - store_test_results:
          path: test-results
      
      - store_artifacts:
          path: test-results
          destination: test-results

  lint:
    executor: python-executor
    working_directory: ~/repo/data-backend
    steps:
      - checkout:
          path: ~/repo
      
      - install-dependencies
      
      - run:
          name: Run flake8
          command: |
            . venv/bin/activate
            pip install flake8
            flake8 people/ config/ --max-line-length=120 --exclude=migrations,__pycache__,venv || true
      
      - run:
          name: Check for common issues
          command: |
            . venv/bin/activate
            python manage.py check

# Define workflows
workflows:
  version: 2
  test-and-lint:
    jobs:
      - lint
      - test:
          requires:
            - lint
