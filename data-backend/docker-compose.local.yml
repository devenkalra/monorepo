# Local/Staging Docker Compose Configuration
# Usage: docker-compose -f docker-compose.local.yml up

services:
  # PostgreSQL Database
  db:
    image: postgres:15-alpine
    container_name: bldrdojo-local-db
    restart: unless-stopped
    ports:
      - "5432:5432"  # Expose for local access
    volumes:
      - postgres_data_local:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=entitydb
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=dbpassword
    networks:
      - backend-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis
  redis:
    image: redis:7-alpine
    container_name: bldrdojo-local-redis
    restart: unless-stopped
    ports:
      - "6380:6379"  # Expose on 6380 to avoid conflict with system Redis
    command: redis-server --appendonly yes --requirepass localredispass
    volumes:
      - redis_data_local:/data
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MeiliSearch
  meilisearch:
    image: getmeili/meilisearch:v1.5
    container_name: bldrdojo-local-meilisearch
    restart: unless-stopped
    ports:
      - "7701:7700"  # Expose on 7701 to avoid conflict
    volumes:
      - meilisearch_data_local:/meili_data
    environment:
      - MEILI_MASTER_KEY=localmeilikey
      - MEILI_ENV=development
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Neo4j
  neo4j:
    image: neo4j:5-community
    container_name: bldrdojo-local-neo4j
    restart: unless-stopped
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    volumes:
      - neo4j_data_local:/data
      - neo4j_logs_local:/logs
    environment:
      - NEO4J_AUTH=neo4j/localneo4jpass
      - NEO4J_dbms_memory_pagecache_size=256M
      - NEO4J_dbms_memory_heap_initial__size=256M
      - NEO4J_dbms_memory_heap_max__size=512M
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "localneo4jpass", "RETURN 1"]
      interval: 10s
      timeout: 10s
      retries: 5

  # Vector Search Service
  vector-service:
    build:
      context: .
      dockerfile: Dockerfile.vector
    container_name: bldrdojo-local-vector
    restart: unless-stopped
    ports:
      - "5000:5000"  # Expose for local access
    volumes:
      - vector_data_local:/app/data
      - ./vector_service.py:/app/vector_service.py  # Live reload
    environment:
      - FLASK_ENV=development
      - VECTOR_DB_PATH=/app/data/chroma
      - CUDA_VISIBLE_DEVICES=""  # Force CPU
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Django Backend
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bldrdojo-local-backend
    restart: unless-stopped
    ports:
      - "8000:8000"  # Django backend on port 8000
    volumes:
      - ./:/app  # Mount entire directory for live reload
      - static_volume_local:/app/staticfiles
      - media_volume_local:/app/media
    environment:
      - DJANGO_SETTINGS_MODULE=config.settings
      - DJANGO_DEBUG=True
      - DJANGO_SECRET_KEY=local-dev-secret-key-change-in-production
      - DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0
      - POSTGRES_DB=entitydb
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=dbpassword
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      - REDIS_URL=redis://:localredispass@redis:6379/0
      - REDIS_PASSWORD=localredispass
      - MEILISEARCH_URL=http://meilisearch:7700
      - MEILI_MASTER_KEY=localmeilikey
      - MEILISEARCH_LOCAL_PORT=7701
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=localneo4jpass
      - VECTOR_SERVICE_URL=http://vector-service:5000
      - CORS_ALLOWED_ORIGINS=http://localhost:5173,http://localhost:5174,http://localhost:3000,http://127.0.0.1:5173,http://127.0.0.1:5174
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_OAUTH_CALLBACK_URL=http://localhost:5174/auth/google/callback
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    networks:
      - backend-network
      - frontend-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: >
      sh -c "
        python manage.py migrate &&
        python manage.py collectstatic --noinput &&
        python manage.py runserver 0.0.0.0:8000
      "

  # React Frontend (Development)
  frontend-dev:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: bldrdojo-local-frontend
    restart: unless-stopped
    ports:
      - "5174:5173"  # Vite dev server
    volumes:
      - ./frontend:/app
      - /app/node_modules  # Don't mount node_modules
    environment:
      - VITE_API_URL=http://localhost:8001
    networks:
      - frontend-network
    command: npm run dev -- --host 0.0.0.0

volumes:
  postgres_data_local:
    name: bldrdojo-local-postgres-data
  redis_data_local:
    name: bldrdojo-local-redis-data
  meilisearch_data_local:
    name: bldrdojo-local-meilisearch-data
  neo4j_data_local:
    name: bldrdojo-local-neo4j-data
  neo4j_logs_local:
    name: bldrdojo-local-neo4j-logs
  vector_data_local:
    name: bldrdojo-local-vector-data
  static_volume_local:
    name: bldrdojo-local-static
  media_volume_local:
    name: bldrdojo-local-media

networks:
  backend-network:
    name: bldrdojo-local-backend-network
    driver: bridge
  frontend-network:
    name: bldrdojo-local-frontend-network
    driver: bridge
