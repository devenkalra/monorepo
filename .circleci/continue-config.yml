version: 2.1

parameters:
  run-frontend: { type: boolean, default: false }
  run-backend: { type: boolean, default: false }
  run-data-backend: { type: boolean, default: false }

jobs:
  build-frontend:
    docker: [{ image: "cimg/node:current" }]
    steps:
      - checkout
      - run: cd frontend && npm install && npm test

  build-backend:
    docker: [{ image: "cimg/python:3.12" }]
    steps:
      - checkout
      - run: cd backend && pip install -r requirements.txt && pytest

  build-data-backend:
    docker:
      - image: cimg/python:3.12
      - image: cimg/postgres:15.3
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
      - image: getmeili/meilisearch:v1.5
        environment:
          MEILI_MASTER_KEY: test_master_key
          MEILI_ENV: development
      - image: neo4j:5-community
        environment:
          NEO4J_AUTH: neo4j/testpassword
          NEO4J_PLUGINS: '["apoc"]'
      - image: cimg/redis:7.0
    environment:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
      NEO4J_URI: bolt://localhost:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: testpassword
      MEILI_HOST: http://localhost:7700
      MEILI_MASTER_KEY: test_master_key
      REDIS_URL: redis://localhost:6379
      DJANGO_SETTINGS_MODULE: config.settings
      SECRET_KEY: test-secret-key-for-ci
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            cd data-backend
            pip install --upgrade pip
            pip install -r requirements.txt
      - run:
          name: Wait for services
          command: |
            # Wait for PostgreSQL
            for i in {1..30}; do
              PGPASSWORD=postgres psql -h localhost -U postgres -d postgres -c "SELECT 1" > /dev/null 2>&1 && break
              echo "Waiting for PostgreSQL..."
              sleep 2
            done
            echo "PostgreSQL is ready"
            # Wait for other services
            sleep 10
      - run:
          name: Debug infrastructure
          command: |
            echo "=== Environment Variables ==="
            echo "DATABASE_URL: $DATABASE_URL"
            echo "NEO4J_URI: $NEO4J_URI"
            echo "MEILI_HOST: $MEILI_HOST"
            echo "REDIS_URL: $REDIS_URL"
            echo ""
            echo "=== PostgreSQL Info ==="
            PGPASSWORD=postgres psql -h localhost -U postgres -d postgres -c "SELECT version();"
            PGPASSWORD=postgres psql -h localhost -U postgres -d postgres -c "\l"
            echo ""
            echo "=== Neo4j Connection ==="
            curl -I http://localhost:7474 || echo "Neo4j HTTP not responding"
            echo ""
            echo "=== MeiliSearch Connection ==="
            curl -s http://localhost:7700/health || echo "MeiliSearch not responding"
            echo ""
            echo "=== Redis Connection ==="
            redis-cli -h localhost ping || echo "Redis not responding"
            echo ""
            echo "=== Python Version ==="
            python --version
            echo ""
            echo "=== Installed Packages ==="
            pip list | grep -E "(Django|psycopg|neo4j|meilisearch|redis)"
            echo ""
            echo "=== Django Check ==="
            cd data-backend
            python manage.py check --database default
      - run:
          name: Run tests
          command: |
            cd data-backend
            python manage.py test people.tests.test_integration_full_stack --verbosity=2


workflows:
  frontend-workflow:
    when: << pipeline.parameters.run-frontend >>
    jobs:
      - build-frontend

  backend-workflow:
    when: << pipeline.parameters.run-backend >>
    jobs:
      - build-backend

  data-backend-workflow:
    when: << pipeline.parameters.run-data-backend >>
    jobs:
      - build-data-backend